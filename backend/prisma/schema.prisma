generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(uuid())
  email             String             @unique
  password          String?
  name              String
  role              UserRole           @default(STUDENT)
  provider          AuthProvider       @default(LOCAL)
  providerId        String?
  termsAcceptedAt   DateTime?
  isActive          Boolean            @default(true)
  lastLoginAt       DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  createdActivities Activity[]         @relation("CreatedActivities")
  activityResponses ActivityResponse[] @relation("StudentResponses")
  adminProfile      AdminProfile?
  chatSessions      ChatSession[]      @relation("UserChatSessions")
  groupMemberships  GroupMember[]      @relation("GroupMemberships")
  notifications     Notification[]
  uploadedPDFs      PDFTextbook[]      @relation("UploadedPDFs")
  pageViews         PageView[]         @relation("StudentPageViews")
  pdfPageViews      PdfPageView[]      @relation("PdfPageViews")
  sessions          Session[]
  studentProfile    StudentProfile?
  teacherProfile    TeacherProfile?
  activities        UserActivity[]

  @@index([email])
  @@index([role])
  @@index([provider, providerId])
}

model TeacherProfile {
  id        String     @id @default(uuid())
  userId    String     @unique
  school    String?
  subject   String?
  grade     String?
  bio       String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  classes   Class[]
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  textbooks Textbook[]
}

model StudentProfile {
  id              String            @id @default(uuid())
  userId          String            @unique
  studentId       String?
  school          String?
  grade           String?
  className       String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  submissions     Assignment[]
  enrollments     ClassEnrollment[]
  questions       Question[]
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  studyRecords    StudyRecord[]
  conceptMasteries ConceptMastery[]
}

model AdminProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  department  String?
  permissions Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Class {
  id            String            @id @default(uuid())
  code          String            @unique @db.VarChar(6)
  name          String
  description   String?
  teacherId     String
  subject       String?
  grade         String?
  semester      String?
  isActive      Boolean           @default(true)
  expiresAt     DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  activities    Activity[]
  announcements Announcement[]
  assignments   Assignment[]
  teacher       TeacherProfile    @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  enrollments   ClassEnrollment[]
  textbooks     ClassTextbook[]
  pdfTextbooks  PDFTextbook[]
  studentGroups StudentGroup[]

  @@index([code])
  @@index([teacherId])
}

model ClassEnrollment {
  id         String         @id @default(uuid())
  classId    String
  studentId  String
  enrolledAt DateTime       @default(now())
  isActive   Boolean        @default(true)
  class      Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  student    StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@index([classId])
  @@index([studentId])
}

model Textbook {
  id          String          @id @default(uuid())
  title       String
  description String?
  content     Json
  metadata    Json?
  authorId    String
  isPublic    Boolean         @default(false)
  isTemplate  Boolean         @default(false)
  aiGenerated Boolean         @default(false)
  aiModel     String?
  aiPrompt    String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  classes     ClassTextbook[]
  author      TeacherProfile  @relation(fields: [authorId], references: [id])
  pages       TextbookPage[]
  concepts    Concept[]       @relation("TextbookConcepts")

  @@index([authorId])
  @@index([isPublic])
}

model ClassTextbook {
  id         String   @id @default(uuid())
  classId    String
  textbookId String
  assignedAt DateTime @default(now())
  class      Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  textbook   Textbook @relation(fields: [textbookId], references: [id], onDelete: Cascade)

  @@unique([classId, textbookId])
}

model TextbookPage {
  id           String          @id @default(uuid())
  textbookId   String
  pageNumber   Int
  title        String?
  content      Json
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  contentType  ContentType     @default(TEXT)
  fileId       String?
  textContent  String?
  chatSessions ChatSession[]
  file         File?           @relation("PageFiles", fields: [fileId], references: [id])
  textbook     Textbook        @relation(fields: [textbookId], references: [id], onDelete: Cascade)
  embeddings   PageEmbedding[]
  concepts     Concept[]       @relation("PageConcepts")

  @@unique([textbookId, pageNumber])
  @@index([textbookId])
  @@index([contentType])
}

model Assignment {
  id          String          @id @default(uuid())
  classId     String
  title       String
  description String
  type        AssignmentType
  dueDate     DateTime?
  points      Int?
  studentId   String?
  submittedAt DateTime?
  submission  Json?
  feedback    String?
  score       Int?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  class       Class           @relation(fields: [classId], references: [id], onDelete: Cascade)
  student     StudentProfile? @relation(fields: [studentId], references: [id])

  @@index([classId])
  @@index([studentId])
}

model StudyRecord {
  id           String         @id @default(uuid())
  studentId    String
  activityType String
  activityData Json
  duration     Int?
  score        Float?
  createdAt    DateTime       @default(now())
  student      StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([createdAt])
}

model Question {
  id           String         @id @default(uuid())
  studentId    String
  question     String
  context      Json?
  aiResponse   String?
  aiModel      String?
  responseTime Int?
  questionType QuestionType
  difficulty   Int?
  createdAt    DateTime       @default(now())
  student      StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([createdAt])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
}

model Announcement {
  id        String   @id @default(uuid())
  classId   String
  title     String
  content   String
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([classId])
}

model UserActivity {
  id        String   @id @default(uuid())
  userId    String
  action    String
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Session {
  id           String   @id @default(uuid())
  token        String   @unique
  userId       String
  ipAddress    String?
  userAgent    String?
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model Document {
  id           String   @id @default(uuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  path         String
  uploaderId   String
  metadata     Json?
  createdAt    DateTime @default(now())

  @@index([uploaderId])
}

model File {
  id            String         @id @default(uuid())
  filename      String
  originalName  String
  mimeType      String
  size          Int
  path          String
  uploadedBy    String
  extractedText String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  pageFiles     TextbookPage[] @relation("PageFiles")

  @@index([uploadedBy])
}

model PDFTextbook {
  id             String        @id @default(uuid())
  classId        String
  filename       String
  fileUrl        String
  fileSize       Int
  totalPages     Int?
  parsedContent  Json?
  status         String        @default("processing")
  uploadedBy     String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  activities     Activity[]
  class          Class         @relation(fields: [classId], references: [id], onDelete: Cascade)
  uploadedByUser User          @relation("UploadedPDFs", fields: [uploadedBy], references: [id])
  pageViews      PageView[]
  pdfPageViews   PdfPageView[] @relation("PdfViews")

  @@index([classId])
  @@index([uploadedBy])
  @@index([status])
}

model PageView {
  id         String      @id @default(uuid())
  studentId  String
  textbookId String
  pageNumber Int
  duration   Int?
  viewedAt   DateTime    @default(now())
  student    User        @relation("StudentPageViews", fields: [studentId], references: [id])
  textbook   PDFTextbook @relation(fields: [textbookId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([textbookId])
  @@index([viewedAt])
}

model Activity {
  id            String             @id @default(uuid())
  classId       String
  textbookId    String?
  title         String
  description   String?
  type          String             @default("fill_in_blank")
  questions     Json
  createdBy     String
  modifiable    Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  class         Class              @relation(fields: [classId], references: [id], onDelete: Cascade)
  createdByUser User               @relation("CreatedActivities", fields: [createdBy], references: [id])
  textbook      PDFTextbook?       @relation(fields: [textbookId], references: [id])
  responses     ActivityResponse[]

  @@index([classId])
  @@index([textbookId])
  @@index([createdBy])
}

model ActivityResponse {
  id          String    @id @default(uuid())
  activityId  String
  studentId   String
  answers     Json
  score       Float?
  feedback    String?
  submittedAt DateTime  @default(now())
  gradedAt    DateTime?
  activity    Activity  @relation(fields: [activityId], references: [id], onDelete: Cascade)
  student     User      @relation("StudentResponses", fields: [studentId], references: [id])

  @@unique([activityId, studentId])
  @@index([activityId])
  @@index([studentId])
  @@index([submittedAt])
}

model StudentGroup {
  id          String                 @id @default(uuid())
  classId     String
  name        String
  description String?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  sessions    CollaborationSession[]
  members     GroupMember[]
  class       Class                  @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([classId])
}

model GroupMember {
  id        String       @id @default(uuid())
  groupId   String
  studentId String
  role      String       @default("member")
  joinedAt  DateTime     @default(now())
  group     StudentGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student   User         @relation("GroupMemberships", fields: [studentId], references: [id])

  @@unique([groupId, studentId])
  @@index([groupId])
  @@index([studentId])
}

model CollaborationSession {
  id          String       @id @default(uuid())
  groupId     String
  activityId  String?
  status      String       @default("active")
  sharedNotes Json?
  schedule    Json?
  startedAt   DateTime     @default(now())
  endedAt     DateTime?
  group       StudentGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([status])
}

model PdfPageView {
  id         String       @id @default(uuid())
  userId     String?
  guestId    String?
  pdfId      String
  pageNumber Int
  timeSpent  Int
  viewedAt   DateTime     @default(now())
  guest      GuestAccess? @relation("GuestPdfViews", fields: [guestId], references: [id])
  pdf        PDFTextbook  @relation("PdfViews", fields: [pdfId], references: [id], onDelete: Cascade)
  user       User?        @relation("PdfPageViews", fields: [userId], references: [id])

  @@index([userId])
  @@index([guestId])
  @@index([pdfId])
  @@index([pageNumber])
  @@index([viewedAt])
}

model GuestAccess {
  id            String        @id @default(uuid())
  accessCode    String        @unique
  textbookId    String?
  expiresAt     DateTime
  maxQuestions  Int           @default(50)
  questionsUsed Int           @default(0)
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  sessionId     String?       @unique
  studentName   String?
  chatSessions  ChatSession[] @relation("GuestChatSessions")
  pdfViews      PdfPageView[] @relation("GuestPdfViews")

  @@index([accessCode])
  @@index([sessionId])
  @@index([expiresAt])
}

model PageEmbedding {
  id         String       @id @default(uuid())
  pageId     String
  chunk      String
  embedding  Float[]
  chunkIndex Int
  metadata   Json?
  createdAt  DateTime     @default(now())
  page       TextbookPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, chunkIndex])
  @@index([pageId])
  @@map("page_embeddings")
}

model ChatSession {
  id          String        @id @default(uuid())
  userId      String?
  guestId     String?
  pageId      String
  sessionName String?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  messages    ChatMessage[]
  guest       GuestAccess?  @relation("GuestChatSessions", fields: [guestId], references: [id])
  page        TextbookPage  @relation(fields: [pageId], references: [id], onDelete: Cascade)
  user        User?         @relation("UserChatSessions", fields: [userId], references: [id])

  @@index([userId])
  @@index([guestId])
  @@index([pageId])
  @@index([isActive])
}

model ChatMessage {
  id              String      @id @default(uuid())
  sessionId       String
  role            MessageRole
  content         String
  metadata        Json?
  retrievedChunks String[]    @default([])
  confidence      Float?
  createdAt       DateTime    @default(now())
  session         ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([role])
  @@index([createdAt])
}

model Concept {
  id                 String             @id @default(uuid())
  name               String
  description        String?
  difficulty         Int                @default(1) // 1-5 scale
  category           String? // e.g., "Mathematics", "Science", "Language"
  keywords           String[] // Related keywords for search
  learningObjectives String[] // What students should learn
  inquiryQuestions   String[] // Socratic questions for this concept
  textbookId         String?
  pageId             String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  textbook           Textbook?          @relation("TextbookConcepts", fields: [textbookId], references: [id], onDelete: Cascade)
  page               TextbookPage?      @relation("PageConcepts", fields: [pageId], references: [id], onDelete: Cascade)
  masteries          ConceptMastery[]
  relationsFrom      ConceptRelation[]  @relation("ConceptFrom")
  relationsTo        ConceptRelation[]  @relation("ConceptTo")

  @@index([textbookId])
  @@index([pageId])
  @@index([difficulty])
  @@index([category])
}

model ConceptRelation {
  id          String       @id @default(uuid())
  fromId      String
  toId        String
  type        RelationType
  strength    Float?       @default(1.0) // 0.0-1.0, how strong is the relationship
  description String?
  createdAt   DateTime     @default(now())
  fromConcept Concept      @relation("ConceptFrom", fields: [fromId], references: [id], onDelete: Cascade)
  toConcept   Concept      @relation("ConceptTo", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([fromId, toId, type])
  @@index([fromId])
  @@index([toId])
  @@index([type])
}

model ConceptMastery {
  id              String         @id @default(uuid())
  studentId       String
  conceptId       String
  masteryLevel    Int            @default(1) // 1-5: Introduction, Developing, Proficient, Advanced, Expert
  confidence      Float?         @default(0.5) // AI's confidence in this assessment
  evidenceCount   Int            @default(0) // Number of learning evidences
  lastEvidence    Json? // Most recent learning evidence (question, answer, score)
  progressHistory Json? // Historical mastery levels over time
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  student         StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  concept         Concept        @relation(fields: [conceptId], references: [id], onDelete: Cascade)

  @@unique([studentId, conceptId])
  @@index([studentId])
  @@index([conceptId])
  @@index([masteryLevel])
  @@index([updatedAt])
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
  GUEST
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

enum AssignmentType {
  HOMEWORK
  QUIZ
  TEST
  PROJECT
  ESSAY
}

enum QuestionType {
  KNOWLEDGE
  REASONING
  CRITICAL
  CREATIVE
  REFLECTION
}

enum NotificationType {
  ASSIGNMENT
  ANNOUNCEMENT
  GRADE
  MESSAGE
  SYSTEM
}

enum ContentType {
  TEXT
  FILE
  MIXED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum RelationType {
  PREREQUISITE  // fromConcept is a prerequisite for toConcept
  RELATED       // Concepts are related/connected
  EXTENDS       // toConcept extends/builds upon fromConcept
  CONTRASTS     // Concepts are contrasting/opposing
  APPLIES       // fromConcept applies to toConcept (application/example)
}
