# 서버 재시작 및 교사 계정 업데이트 명령어
# ========================================
# 서버에 SSH로 접속 후 아래 명령어를 순서대로 실행하세요.

# 1. 서버 접속
ssh ubuntu@3.37.168.225

# 2. 서비스 캐시 삭제 및 재시작
pm2 flush
pm2 restart backend --update-env
sudo systemctl restart digitalbook
sudo rm -rf /var/cache/nginx/*
sudo nginx -s reload
docker exec digitalbook-redis-1 redis-cli FLUSHALL

# 3. 교사 계정 비밀번호 업데이트
cd /home/ubuntu/digitalbook/backend

cat > update-teacher-password.js << 'EOF'
const { PrismaClient } = require('@prisma/client');
const bcrypt = require('bcryptjs');

const prisma = new PrismaClient();

async function updateTeacherPassword() {
  try {
    const hashedPassword = await bcrypt.hash('teacher123!', 10);
    
    const teacher = await prisma.user.update({
      where: {
        email: 'teacher1@test.com'
      },
      data: {
        password: hashedPassword
      }
    });
    
    console.log('✅ Teacher password updated successfully!');
    console.log('   Email: teacher1@test.com');
    console.log('   Password: teacher123!');
  } catch (error) {
    console.error('❌ Error:', error.message);
  } finally {
    await prisma.$disconnect();
  }
}

updateTeacherPassword();
EOF

node update-teacher-password.js

# 4. 서비스 상태 확인
pm2 list
sudo systemctl status digitalbook
sudo nginx -t